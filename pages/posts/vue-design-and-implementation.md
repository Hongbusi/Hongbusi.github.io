---
title: 'Vue.js 设计与实现'
date: '2022-02-16'
zh: 'zh'
---

记录阅读《Vue.js 设计与实现》过程中的收获。

## `WeakMap` 和 `Map` 的区别（p48）

`WeakMap` 对 `key` 是弱引用，不影响垃圾回收器的工作。据这个特性可知，一旦 `key` 被垃圾回收器回收，那么对应的键和值就访问不到了。所以 `WeakMap` 经常用于存储那些只有当 `key` 所引用的对象存在时（没有被回收）才有价值的信息，例如上面的场景中，如何 `target` 对象没有任何引用了，说明用户侧不再需要它了，这是垃圾回收器就完成回收任务。但如果使用 `Map` 来代替 `WeakMap`，那么即使用户侧的代码对 `target` 没有任何引用，这个 `target` 也不会被回收，最终可能导致内存溢出。

## `forEach` 遍历 `Set` 集合（p55）

在调用 `forEach` 遍历 `Set` 集合时，如果一个值已经被访问过了，但该值被删除并重新添加到集合，如果此时 `forEach` 遍历没有结束，那么该值会重新被访问。解决办法很简单，我们可以构造另一个 `Set` 集合并遍历它。
